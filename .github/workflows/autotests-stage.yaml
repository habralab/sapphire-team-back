name: Autotests Stage
on:
  schedule:
    - cron: "43 * * * *"
  workflow_dispatch: {}
jobs:
  build:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main
      - name: Build
        run: docker build -t sapphire:test-${{ github.sha }} --target full .
  test:
    needs: [build]
    runs-on: self-hosted
    steps:
      - name: Autotests
        run: >
          docker run --rm
          -e "MESSENGER_BASE_URL=${MESSENGER__API__ROOT_URL__STAGE}${MESSENGER__API__ROOT_PATH__STAGE}"
          -e "NOTIFICATIONS_BASE_URL=${NOTIFICATIONS__API__ROOT_URL__STAGE}${NOTIFICATIONS__API__ROOT_PATH__STAGE}"
          -e "PROJECTS_BASE_URL=${PROJECTS__API__ROOT_URL__STAGE}${PROJECTS__API__ROOT_PATH__STAGE}"
          -e "STORAGE_BASE_URL=${STORAGE__API__ROOT_URL__STAGE}${STORAGE__API__ROOT_PATH__STAGE}"
          -e "USERS_BASE_URL=${USERS__API__ROOT_URL__STAGE}${USERS__API__ROOT_PATH__STAGE}"
          -e "OAUTH2_HABR_CALLBACK_URL=${USERS__API__OAUTH2_HABR_CALLBACK_URL__STAGE}"
          -e "OLEG_EMAIL=${OLEG_EMAIL}"
          -e "OLEG_EMAIL_PASSWORD=${OLEG_EMAIL_PASSWORD}"
          -e "MATVEY_EMAIL=${MATVEY_EMAIL}"
          -e "MATVEY_EMAIL_PASSWORD=${MATVEY_EMAIL_PASSWORD}"
          -v /sapphire/stage/secrets:/run/secrets
          sapphire:test-${{ github.sha }} pytest autotests
      - name: Notification
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            @WainsCat @vanvanich9 @brulitsan @OlegYurchik
            Autotests Failed
            Last commit: https://github.com/${{ github.repository }}/commit/${{github.sha}}
